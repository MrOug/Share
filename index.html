// FIXED genChartV3 function - Replace your existing one (around line 1641)

async function genChartV3(){
const inst=document.getElementById('cInst').value.trim();
const inc=document.getElementById('cInc').value.trim();
const rng=document.getElementById('cRng').value;
if(!accessToken){log('‚ùå Login');return;}
if(!inst||!inc){log('‚ùå Fill fields');return;}
log('== V3 CHART ==');

const win=window.open('','_blank');

// FIX: Use string concatenation, not nested template literals
const html = '
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>' + inst + '</title>' +
    '
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"><\/script>' +
        '<style>*{margin:0;padding:0}body{background:#0a0e1a;font-family:monospace;overflow:hidden}' +
            '#chart{width:100vw;height:100vh}#controls{position:absolute;top:15px;left:15px;z-index:20;' +
            'background:rgba(0,0,0,0.95);padding:15px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.5);max-width:450px}' +
            '.title{font-size:20px;font-weight:bold;margin-bottom:12px;color:#fff;word-wrap:break-word}' +
            '.tf-btn{background:#1e293b;color:#fff;border:2px solid #334155;padding:8px 16px;margin:0 4px 8px 0;' +
            'border-radius:6px;cursor:pointer;font-size:13px;font-weight:bold;font-family:monospace;transition:all 0.2s}' +
            '.tf-btn:hover{background:#334155;border-color:#475569}.tf-btn.active{background:#2563eb;border-color:#3b82f6}' +
            '.badges{margin-top:12px;max-height:100px;overflow-y:auto}' +
            '.badge{display:inline-block;font-size:11px;font-weight:bold;padding:5px 12px;border-radius:5px;margin:3px 5px 3px 0;white-space:nowrap}' +
            '.pm{background:#26a69a;color:#000}.py{background:#2563eb;color:#fff}' +
            '.legend{font-size:10px;color:#888;margin-top:12px}.loading{color:#2563eb;margin-top:8px;font-size:11px}' +
            '</style></head><body><div id="controls"><div class="title">' + inst + '</div><div>' +
            '<button class="tf-btn" onclick="loadTF(\'hours\',4,this)">4H</button>' +
            '<button class="tf-btn active" onclick="loadTF(\'days\',1,this)">1D</button>' +
            '<button class="tf-btn" onclick="loadTF(\'weeks\',1,this)">1W</button></div>' +
            '<div class="loading" id="ld" style="display:none">Loading...</div><div class="badges" id="lbl"></div>' +
            '<div class="legend">üîµ PY (birth month) | üü¢ PM (every month)</div></div><div id="chart"></div>' +
            '<script>' +
            'const TK="' + accessToken + '";const IN="' + inst + '";const IC="' + inc + '";const RG="' + rng + '";' +
            'let ch,cs;const ms=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];' +
            'const bm=parseInt(IC.split("/")[1]);' +
            'function cPY(i,t){const ip=i.split("/");const bd=parseInt(ip[0]),bm=parseInt(ip[1]);' +
            'const mm={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};' +
            'const tp=t.split(" ");const tm=mm[tp[0]],ty=parseInt(tp[1]);const yu=tm>=bm?ty:ty-1;let to=bd+bm;' +
            'for(const d of yu.toString())to+=parseInt(d);const mn=[11,22,28,33,20];if(mn.includes(to))return to;' +
            'while(to>9){to=to.toString().split("").reduce((s,d)=>s+parseInt(d),0);if(mn.includes(to))return to;}return to;}' +
            'function cPM(i,t){const ip=i.split("/");const bd=parseInt(ip[0]),bm=parseInt(ip[1]);' +
            'const mm={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};' +
            'const tp=t.split(" ");const tm=mm[tp[0]],ty=parseInt(tp[1]);const yu=tm>=bm?ty:ty-1;let to=bd+bm+tm;' +
            'for(const d of yu.toString())to+=parseInt(d);const mn=[11,22,28,33,20];if(mn.includes(to))return to;' +
            'while(to>9){to=to.toString().split("").reduce((s,d)=>s+parseInt(d),0);if(mn.includes(to))return to;}return to;}' +
            // CORRECTED V3 API: /{instrument}/{unit}/{interval}/{to}/{from}
            'async function loadTF(unit,interval,el){document.querySelectorAll(".tf-btn").forEach(b=>b.classList.remove("active"));' +
            'if(el)el.classList.add("active");document.getElementById("ld").style.display="block";' +
            'const to=new Date();let from=new Date();' +
            'if(RG==="1Y")from.setFullYear(to.getFullYear()-1);' +
            'else if(RG==="2Y")from.setFullYear(to.getFullYear()-2);' +
            'else if(RG==="5Y")from.setFullYear(to.getFullYear()-5);' +
            'else from.setFullYear(to.getFullYear()-10);' +
            'const url="https://api.upstox.com/v3/historical-candle/"+encodeURIComponent(IN)+"/"+unit+"/"+interval+"/"' +
            '+to.toISOString().split("T")[0]+"/"+from.toISOString().split("T")[0];' +
            'try{const r=await fetch(url,{headers:{Accept:"application/json",Authorization:"Bearer "+TK}});' +
            'if(!r.ok)throw new Error("API "+r.status);const res=await r.json();' +
            'if(!res.data||!res.data.candles||!res.data.candles.length)throw new Error("No data");' +
            'const cn=res.data.candles.reverse();const cd=[];const mk=[];const pm=new Map();let lm=-1;' +
            'for(const[ts,o,h,l,c]of cn){const d=new Date(ts);const my=ms[d.getMonth()]+" "+d.getFullYear();' +
            'const p=cPM(IC,my);const y=cPY(IC,my);const t=Math.floor(d.getTime()/1000);' +
            'cd.push({time:t,open:o,high:h,low:l,close:c});const nm=d.getMonth()!==lm;if(nm){lm=d.getMonth();' +
            'const ib=d.getMonth()+1===bm;if(ib){' +
            'mk.push({time:t,position:"aboveBar",color:"#2563eb",shape:"circle",text:"PY:"+y+" PM:"+p,size:1});' +
            'pm.set("PY:"+y+" PM:"+p,{label:"PY:"+y+" PM:"+p,isPY:true});}else{' +
            'mk.push({time:t,position:"belowBar",color:"#26a69a",shape:"circle",text:"PM:"+p,size:1});' +
            'pm.set("PM:"+p,{label:"PM:"+p,isPY:false});}}}cs.setData(cd);cs.setMarkers(mk);' +
            'const lb=document.getElementById("lbl");lb.innerHTML="";' +
            'for(const[_,l]of pm){lb.innerHTML+="<span class=\\"badge "+(l.isPY?"py":"pm")+"\\">"+ l.label+"</span>";}' +
            'document.getElementById("ld").style.display="none";}catch(e){alert("Error: "+e.message);' +
            'document.getElementById("ld").style.display="none";}}' +
            'ch=LightweightCharts.createChart(document.getElementById("chart"),{' +
            'layout:{background:{color:"#0a0e1a"},textColor:"#d1d4dc"},' +
            'grid:{vertLines:{color:"#1a1f33"},horzLines:{color:"#1a1f33"}},' +
            'crosshair:{mode:LightweightCharts.CrosshairMode.Normal},' +
            'rightPriceScale:{borderColor:"#2b2b43"},timeScale:{borderColor:"#2b2b43",timeVisible:true},' +
            'width:window.innerWidth,height:window.innerHeight});' +
            'cs=ch.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderUpColor:"#26a69a",' +
            'borderDownColor:"#ef5350",wickUpColor:"#26a69a",wickDownColor:"#ef5350"});' +
            'window.addEventListener("resize",()=>{ch.applyOptions({width:window.innerWidth,height:window.innerHeight});});' +
            'loadTF("days",1);<\/script></body></html>';

        win.document.write(html);
        win.document.close();
        log('‚úì V3 Chart opened');
}
